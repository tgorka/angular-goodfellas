/**
 * Utility filters, config, services and directives for use in angular 1.2.x
 * @version 1.0.0 - 17/07/2015
 * @company Luxia SAS
 * @author: Tomasz Gorka
 * @licence MIT License
 */
angular.module("ngUtilities",[]).filter("n",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("byteFilter",["$filter",function(e){return function(t){return t>=1073741824?e("roundFilter")(t/1073741824,2)+" Go":t>=1048576?e("roundFilter")(t/1048576,2)+" Mo":t>=1024?e("roundFilter")(t/1024,2)+" Ko":t>1?t+" Octets":1==t?"1 Octet":"0 Octet"}}]).filter("percentFilter",["$filter",function(e){return function(t,n){return e("roundFilter")(100*t/n,2)+" %"}}]).filter("roundFilter",[function(){return function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}}]).filter("makeRange",[function(){return function(e){var t,n,r;switch(e.length){case 1:t=0,n=parseInt(e[0])-1,r=!0;break;case 2:t=parseInt(e[0]),n=parseInt(e[1]),r=!0;break;case 3:t=parseInt(e[0]),n=parseInt(e[1]),r=!1;break;default:return e}var i=[];if(r)for(var a=t;n>=a;a++)i.push(a);else for(var a=n;a>=t;a--)i.push(a);return i}}]).filter("ensureArraySinceNow",[function(){return function(e){for(var t=(new Date).getFullYear();e.length>0&&parseInt(e[0])>t;)e.shift();return 0==e.length?e.push(t):parseInt(e[0])<t&&e.unshift(t),e}}]).filter("fillBetweenFirstLastValues",[function(){return function(e){var t,n,r=[];switch(e.length){case 0:break;case 1:r.push(e[0]);break;default:if(t=parseInt(e[0]),n=parseInt(e[e.length-1]),n>t)for(var i=t;n>=i;i++)r.push(i);else for(var i=t;i>=n;i--)r.push(i)}return r}}]).config(["$urlMatcherFactoryProvider",function(e){e.strictMode(!1),e.type("uriType",{encode:function(e){return e&&e.toString().replace(/ /g,"-")},decode:function(e){return e&&e.toString()},is:angular.isString,pattern:/.+/})}]).factory("transformRequestDataAsFormPost",[function(){return function(e){if(!angular.isObject(e))return null==e?"":e.toString();var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];t.push(encodeURIComponent(n)+"="+encodeURIComponent(null==r?"":r))}return t.join("&").replace(/%20/g,"+")}}]).factory("sizingService",["$window","$rootScope","$timeout",function(e,t,n){var r=e.innerHeight,i=e.innerWidth,a=e.document.getElementById("header").offsetHeight,o=r-a,s=function(){var s=function(){r=e.innerHeight,i=e.innerWidth,a=e.document.getElementById("header").offsetHeight,o=r-a};t.$$phase?n(s):t.$apply(s)};return e.addEventListener("orientationchange",function(){s()}),e.addEventListener("resize",function(){s()}),e.addEventListener("load",function(){s()}),{sync:function(){s()},getHeaderHeight:function(){return a},getWindowHeight:function(){return r},getWindowWidth:function(){return i},getContentHeight:function(){return o}}}]).factory("calendarService",[function(){return{getWeekdayNumber:function(e,t){var n=new Date;n.setFullYear(e,t,1);var r=n.getDay();return 0==r?r=6:r--,r},getDayCount:function(e,t){return 2==t?e%400==0?29:e%4==0&&e%100!=100?29:28:4==t||6==t||9==t||11==t?30:31}}}]).factory("browserHacksService",["$window",function(e){return{localStorage:function(){if("object"==typeof localStorage)try{e.sessionStorage.setItem("localStorage",1),e.sessionStorage.removeItem("localStorage")}catch(t){Storage.prototype._setItem=Storage.prototype.setItem,Storage.prototype.setItem=function(){},console.log('WARNING: Your web browser does not support storing settings locally. In Safari, the most common cause of this is using "Private Browsing Mode". Some settings may not save or some features may not work properly for you.')}}}}]).directive("isChecked",[function(){return{restrict:"A",require:"?ngModel",link:function(e,t,n,r){if(r){e.$watch(n.ngModel,function(){i()});var i=function(){var e=r.$viewValue;r.$setValidity("isChecked",e)}}}}}]).directive("crypt",[function(){return{restrict:"A",require:"?ngModel",link:function(e,t,n,r){if(r){var i=function(){r.$setViewValue(CryptoJS.SHA512(t.val()||""))};e.$watch(n.ngModel,function(){t.val()==r.$viewValue&&i()}),r.$render=function(){var e=r.$viewValue;t.val(e&&e.length>0?"Crypted value":"")}}}}}]).directive("utilitiesSubmitButton",[function(){return{restrict:"E",require:"^utilitiesForm",transclude:!0,template:'<div class="btn-group btn-group-justified margin-vertical-lg"><button type="submit" class="full-width btn btn-link btn-lg text-large" ng-class="summitClass()" role="button" ng-transclude></button></div>'}}]).directive("utilitiesFieldGroup",["$compile","$timeout",function(e,t){return{restrict:"E",require:"^utilitiesForm",transclude:!0,scope:{},controller:["$scope",function(e){e.isSuccessMessagesVisible=!1,e.successMessagesDuration=500,e.successMessagesTimer=null,e.showSuccessMessages=function(){e.successMessagesTimer&&t.cancel(e.successMessagesTimer),e.isSuccessMessagesVisible=!0,e.successMessagesTimer=t(function(){e.isSuccessMessagesVisible=!1},e.successMessagesDuration)},e.getField=function(){return e.$parent.formName&&e.$parent[e.$parent.formName]&&e.$parent[e.$parent.formName][e.fieldName]?e.$parent[e.$parent.formName][e.fieldName]:null},e.getGroupClass=function(){var t=e.getField();if(t&&!t.$pristine){if(!t.$valid)return"has-error";if(e.isSuccessMessagesVisible)return"has-success"}return""},e.isShowingInvalid=function(){var t=e.getField();return t?t.$dirty&&t.$invalid:!1},e.isShowingValid=function(){var t=e.getField();return t?t.$dirty&&t.$valid&&e.isSuccessMessagesVisible:!1},e.isShowingError=function(t){var n=e.getField();return n?n.$dirty&&n.$error[t]:!1},e.getServerValidationMessages=function(){return e.$parent.serverValidation[e.fieldName]?e.$parent.serverValidation[e.fieldName]:[]}}],link:function(t,n,r){var i=null;if(t.innerClass=r.innerClass?r.innerClass:"text-left",r.$observe("innerClass",function(e){e&&(t.innerClass=e)}),angular.forEach(n.children(),function(n){angular.forEach(angular.element(n).children(),function(n){var r=angular.element(n);void 0!=r.attr("name")?(r.hasClass("form-control")||r.addClass("form-control"),void 0==r.attr("ng-model")&&console.log("WARNING: there is no ngModel set in the element"),i=r):(r.hasClass("no-label")||(r.addClass("label"),r.addClass("label-danger"),r.addClass("margin-right-sl"),r.addClass("margin-vertical-sl"),r.addClass("inline"),r.addClass("full-max-width")),e(r)(t))})}),i){t.fieldName=i.attr("name"),t.fieldElement=i;var a=i.attr("ng-model");a&&t.$watch("$parent."+a,function(){var e=t.getField();e&&e.$dirty&&(e.$setValidity("serverValidation",!0),e.$valid&&t.showSuccessMessages())});var o=angular.element('<span class="label label-danger margin-right-sl margin-vertical-sl inline full-max-width" ng-repeat="message in getServerValidationMessages()" ng-show="isShowingError(\'serverValidation\')" ng-bind-html="message | n"></span>'),s=angular.element('<span class="glyphicon glyphicon-ok form-control-feedback" ng-show="isShowingValid()"></span>'),c=angular.element('<span class="glyphicon glyphicon-remove form-control-feedback" ng-show="isShowingInvalid()"></span>');i.after(o),i.after(s),i.after(c),e(o)(t),e(s)(t),e(c)(t)}},template:'<div class="form-group has-feedback margin-vertical {{innerClass}}" ng-class="getGroupClass()" ng-transclude></div>'}}]).directive("utilitiesForm",["$http","transformRequestDataAsFormPost",function(e,t){return{restrict:"A",link:function(e,t,n){n.name?e.formName=n.name:console.log("WARNING: There is no form[name] specified. Don't binding utilities form into fields."),n.action?t[0].onsubmit=function(t){t.preventDefault(),t.stopPropagation(),e.submitForm(n.action)}:n.ngSubmit||console.log("WARNING: There is no form[ngSubmit] not form[action] specified. Don't binding utilities form sending."),n.method?e.formMethod=n.method.toLowerCase():(e.formMethod="get",n.$set("method",e.formMethod)),n.role||n.$set("role","form"),n.enctype?e.formEnctype=n.enctype:(e.formEnctype="application/x-www-form-urlencoded;charset=utf-8",n.$set("enctype",e.formEnctype)),n.accept?e.formAccept=n.accept:(e.formAccept="application/json",n.$set("accept",e.formAccept)),e.formAcceptCharset=n.acceptCharset?n.acceptCharset:void 0},controller:["$scope",function(n){n.data={},n.serverValidation={},n.summitClass=function(){return!n.formName||!n[n.formName]||n[n.formName].$dirty&&n[n.formName].$valid?"":"disabled"},n.submitForm=function(r){if(!n.onSubmitForm||n.onSubmitForm()){var i={method:n.formMethod,url:r,headers:{"Content-Type":n.formEnctype,Accept:n.formAccept}};n.formAcceptCharse&&(i.headers["Accept-Charset"]=n.formAcceptCharset),"get"==n.formMethod?i.params=n.data:i.data=n.data,n.formEnctype.indexOf("x-www-form-urlencoded")>=0&&(i.transformRequest=t),e(i).success(function(e){n.$emit("formSubmited",e)}).error(function(e,t){if(422==t){if(n.serverValidation=e,n.formName&&n[n.formName])for(var r in e)n[n.formName][r]&&(n[n.formName][r].$dirty=!0,n[n.formName][r].$setValidity("serverValidation",!1));n.$emit("formSubmitedInvalid",e)}})}},n.$emit("formInited",{data:n.data})}]}}]).directive("hasGridElements",[function(){return{restrict:"A",controller:["$scope",function(e){e.width=60,e.updateWidth=function(t){t>e.width&&(e.$$phase?e.width=t:e.$apply(function(){e.width=t}))}}]}}]).directive("gridElement",[function(){return{restrict:"A",transclude:!0,require:"^hasGridElements",link:function(e,t){var n=function(){return t.prop("clientWidth")};e.$watch(n,function(t){e.$parent.updateWidth(t)},!0)},template:'<div ng-transclude style="min-width:{{$parent.width}}px;"></div>'}}]);